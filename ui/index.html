<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>RAG Document Q&A</title>

    <style>
        body {
            background: #0b1020;
            color: #e8eeff;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
            margin: 0;
        }

        .wrap {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 16px
        }

        .card {
            background: #111a33;
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 16px
        }

        h1 {
            margin: 0 0 6px
        }

        .sub {
            color: #a9b5d6;
            margin-bottom: 20px
        }

        label {
            font-size: 13px;
            color: #a9b5d6
        }

        input,
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid #2a355a;
            background: #0f1730;
            color: #e8eeff
        }

        textarea {
            min-height: 90px
        }

        button {
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #4f7cff;
            background: #223a7a;
            color: white;
            font-weight: 600;
            cursor: pointer
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed
        }

        .hint {
            font-size: 12px;
            color: #a9b5d6;
            margin-top: 6px
        }

        .answerBox {
            white-space: pre-wrap;
            margin-top: 10px;
            background: #0f1730;
            padding: 12px;
            border-radius: 10px
        }

        details {
            background: #0f1730;
            padding: 10px;
            border-radius: 10px;
            margin-top: 8px
        }

        summary {
            cursor: pointer;
            font-weight: 700
        }

        .mono {
            font-family: monospace
        }

        .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, .3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin .7s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 6px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>RAG Document Q&A</h1>
        <p class="sub">Upload a document → ask questions → refresh clears memory.</p>

        <!-- API -->
        <div class="card">
            <label>API Base URL</label>
            <input id="baseUrl" placeholder="http://127.0.0.1:8000" />
            <div class="hint">Saved locally (only this).</div>
        </div>

        <!-- INGEST -->
        <div class="card">
            <h3>1) Ingest PDF / TXT</h3>
            <input id="fileInput" type="file" accept=".pdf,.txt" />
            <button id="btnIngest">Ingest</button>
            <div class="hint" id="ingestInfo"></div>
        </div>

        <!-- ASK -->
        <div class="card">
            <h3>2) Ask Question</h3>
            <input id="question" placeholder="What are the limitations of LLMs?" />
            <button id="btnAsk">Ask</button>
            <div class="answerBox" id="answerBox" style="display:none"></div>

            <details id="stepsBox" style="display:none">
                <summary>Steps</summary>
                <div id="steps"></div>
            </details>

            <details id="sourcesBox" style="display:none">
                <summary>Sources</summary>
                <div id="sources"></div>
            </details>
        </div>
    </div>

    <script>
        /* ---------------- STATE ---------------- */
        let CURRENT_DOC_ID = null;

        /* ---------------- HELPERS ---------------- */
        const $ = (id) => document.getElementById(id);
        function toast(msg) { alert(msg); }

        /* ---------------- BASE URL ---------------- */
        const baseInput = $("baseUrl");
        baseInput.value = localStorage.getItem("rag_base") || "http://127.0.0.1:8000";
        baseInput.oninput = () => localStorage.setItem("rag_base", baseInput.value.trim());

        /* ---------------- INGEST ---------------- */
        $("btnIngest").onclick = async () => {
            const file = $("fileInput").files[0];
            if (!file) { toast("Choose a PDF/TXT"); return; }

            const base = baseInput.value.replace(/\/$/, "");
            const fd = new FormData();
            fd.append("file", file);

            const ingestBtn = $("btnIngest");
            const ingestText = ingestBtn.textContent;

            ingestBtn.disabled = true;
            ingestBtn.innerHTML = `<span class="spinner"></span> Ingesting...`;

            try {
                const r = await fetch(`${base}/ingest`, { method: "POST", body: fd });
                const d = await r.json();
                if (!r.ok) throw d.detail;

                CURRENT_DOC_ID = d.doc_id;
                $("ingestInfo").innerHTML =
                    `✅ Ingested <span class="mono">${d.file}</span> • chunks: ${d.chunks}`;

            } catch (e) {
                toast("Ingest failed: " + e);
            } finally {
                ingestBtn.disabled = false;
                ingestBtn.textContent = ingestText;
            }
        };

        /* ---------------- PARSE ANSWER ---------------- */
        function parseAnswer(text) {
            const def = text.match(/Definition:\s*([\s\S]*?)(?=\nSteps:|$)/i);
            const steps = text.match(/Steps:\s*([\s\S]*)/i);

            return {
                answer: def ? def[1].trim() : text,
                steps: steps
                    ? steps[1].split("\n").map(s => s.replace(/^[-•\d.)]+\s*/, "").trim()).filter(Boolean)
                    : []
            };
        }

        /* ---------------- ASK ---------------- */
        $("btnAsk").onclick = async () => {
            const q = $("question").value.trim();
            if (!q) { toast("Write a question"); return; }
            if (!CURRENT_DOC_ID) {
                toast("First ingest a document. Refresh clears memory.");
                return;
            }

            const base = baseInput.value.replace(/\/$/, "");
            const askBtn = $("btnAsk");
            const askText = askBtn.textContent;

            askBtn.disabled = true;
            askBtn.innerHTML = `<span class="spinner"></span> Asking...`;

            try {
                const r = await fetch(`${base}/ask`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ doc_id: CURRENT_DOC_ID, question: q })
                });
                const d = await r.json();
                if (!r.ok) throw d.detail;

                const parsed = parseAnswer(d.answer || "");
                $("answerBox").textContent = parsed.answer;
                $("answerBox").style.display = "block";

                $("steps").innerHTML = parsed.steps.map(s => `• ${s}`).join("<br>");
                $("stepsBox").style.display = parsed.steps.length ? "block" : "none";

                $("sources").innerHTML = (d.sources || []).map(
                    s => `<div class="mono">#${s.id} (${s.score.toFixed(3)}) — ${s.source}<br>${s.text_preview}</div><hr>`
                ).join("");
                $("sourcesBox").style.display = d.sources?.length ? "block" : "none";

            } catch (e) {
                toast("Ask failed: " + e);
            } finally {
                askBtn.disabled = false;
                askBtn.textContent = askText;
            }
        };
    </script>
</body>

</html>